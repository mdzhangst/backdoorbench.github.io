<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>defense.mcr &mdash; BackdoorBench v2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/mytheme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/version_alert.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/pyg_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../start/installation.html">Install and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/quickstart.html">Quick Start by Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/bddataset.html">Build Your Own Backdoor Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/attack.html">Build Your Own Backdoor Attack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/defense.html">Build Your Own Backdoor Defense</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PACKAGE REFERENCE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/attack.html">packages of attack and defense</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Visualization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/analysis_readme.html">Analysis Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/Demo_FV.html">Demo_FV</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BackdoorBench</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">defense.mcr</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for defense.mcr</h1><div class="highlight"><pre>
<span></span><span class="c1"># python defense/mcr/mcr.py --save_path /workspace/chenhongrui/bdzoo2/record/t_914_badnet</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This file is modified based on the following source:</span>
<span class="sd">link : https://github.com/IBM/model-sanitization.</span>
<span class="sd">The defense method is called MCR.</span>

<span class="sd">Since the model is different from original paper, we change the hyperparameter for preactresnet18 on cifar10 to align the performance.</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># sys.path.append(&#39;../&#39;)</span>
<span class="c1"># sys.path.append(os.getcwd())</span>

<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="c1"># import logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># from pyhessian import hessian  # Hessian computation</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># import numpy as np</span>

<span class="kn">from</span> <span class="nn">backdoorbench.defense.base</span> <span class="kn">import</span> <span class="n">defense</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.aggregate_block.train_settings_generate</span> <span class="kn">import</span> <span class="n">argparser_opt_scheduler</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.trainer_cls</span> <span class="kn">import</span> <span class="n">ModelTrainerCLS_v2</span><span class="p">,</span> <span class="n">BackdoorModelTrainer</span><span class="p">,</span> <span class="n">Metric_Aggregator</span><span class="p">,</span> <span class="n">given_dataloader_test</span><span class="p">,</span> \
    <span class="n">general_plot_for_epoch</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.choose_index</span> <span class="kn">import</span> <span class="n">choose_index</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.aggregate_block.fix_random</span> <span class="kn">import</span> <span class="n">fix_random</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.aggregate_block.model_trainer_generate</span> <span class="kn">import</span> <span class="n">generate_cls_model</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.log_assist</span> <span class="kn">import</span> <span class="n">get_git_info</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.aggregate_block.dataset_and_transform_generate</span> <span class="kn">import</span> <span class="n">get_input_shape</span><span class="p">,</span> <span class="n">get_num_classes</span><span class="p">,</span> <span class="n">get_transform</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.save_load_attack</span> <span class="kn">import</span> <span class="n">load_attack_result</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.bd_dataset_v2</span> <span class="kn">import</span> <span class="n">prepro_cls_DatasetBD_v2</span><span class="p">,</span> <span class="n">dataset_wrapper_with_transform</span>
<span class="kn">from</span> <span class="nn">backdoorbench.utils.trainer_cls</span> <span class="kn">import</span> <span class="n">test_given_dataloader_on_mix</span><span class="p">,</span> <span class="n">all_acc</span><span class="p">,</span> <span class="n">plot_acc_like_metric_pure</span><span class="p">,</span> \
    <span class="n">validate_list_for_plot</span>  <span class="c1"># plot_loss, plot_acc_like_metric,</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># import math</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="c1"># import torch.nn.functional as F</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="c1"># from torch.nn.modules.utils import _pair</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">binom</span>


<span class="k">def</span> <span class="nf">plot_loss</span><span class="p">(</span>
        <span class="n">train_loss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">clean_test_loss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">bd_test_loss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_file_name</span><span class="o">=</span><span class="s2">&quot;loss_metric_plots&quot;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;These line of set color is from https://stackoverflow.com/questions/8389636/creating-over-20-unique-legend-colors-using-matplotlib&#39;&#39;&#39;</span>
    <span class="n">NUM_COLORS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gist_rainbow&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">12.8</span><span class="p">,</span> <span class="mf">9.6</span><span class="p">))</span>  <span class="c1"># 4x default figsize</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">cm</span><span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">NUM_COLORS</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_COLORS</span><span class="p">)])</span>

    <span class="n">len_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loss_list</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span> <span class="o">*</span> <span class="n">frequency</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">train_loss_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_loss_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train Loss&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;train_loss_list contains None or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">clean_test_loss_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clean_test_loss_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test Clean loss&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;clean_test_loss_list contains None or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">bd_test_loss_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bd_test_loss_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test Backdoor Loss&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;bd_test_loss_list contains None or len not match&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span>
              <span class="nb">max</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span>  <span class="c1"># filter None value</span>
                   <span class="n">train_loss_list</span> <span class="o">+</span>
                   <span class="n">clean_test_loss_list</span> <span class="o">+</span>
                   <span class="n">bd_test_loss_list</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
              <span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Results&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_file_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_acc_like_metric</span><span class="p">(</span>
        <span class="n">train_acc_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">train_asr_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">train_ra_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">test_acc_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">test_asr_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">test_ra_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_file_name</span><span class="o">=</span><span class="s2">&quot;acc_like_metric_plots&quot;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

<span class="p">):</span>
    <span class="n">len_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_asr_list</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_asr_list</span><span class="p">))</span> <span class="o">*</span> <span class="n">frequency</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;These line of set color is from https://stackoverflow.com/questions/8389636/creating-over-20-unique-legend-colors-using-matplotlib&#39;&#39;&#39;</span>
    <span class="n">NUM_COLORS</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gist_rainbow&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">12.8</span><span class="p">,</span> <span class="mf">9.6</span><span class="p">))</span>  <span class="c1"># 4x default figsize</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">cm</span><span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">NUM_COLORS</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_COLORS</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">train_acc_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_acc_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train Acc&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;train_acc_list contains None, or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">train_asr_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_asr_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train ASR&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;train_asr_list contains None, or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">train_ra_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_ra_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train RA&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;train_ra_list contains None, or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">test_acc_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">test_acc_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test C-Acc&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;test_acc_list contains None, or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">test_asr_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">test_asr_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test ASR&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;test_asr_list contains None, or len not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_list_for_plot</span><span class="p">(</span><span class="n">test_ra_list</span><span class="p">,</span> <span class="n">len_set</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">test_ra_list</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test RA&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;test_ra_list contains None, or len not match&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ACC&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Results&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_file_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c1"># def plot_hessian_eigenvalues(</span>
<span class="c1">#         model_visual,</span>
<span class="c1">#         data_loader,  # only use one batch</span>
<span class="c1">#         device,</span>
<span class="c1">#         save_path_for_hessian=None,  # xx/xx/xx.png</span>
<span class="c1"># ):</span>
<span class="c1">#     # save_path_for_hessian =</span>
<span class="c1">#     # data_loader =</span>
<span class="c1">#     # device =</span>
<span class="c1">#     # model_visual =</span>
<span class="c1">#</span>
<span class="c1">#     model_visual = (model_visual)</span>
<span class="c1">#     data_loader = (data_loader)</span>
<span class="c1">#     model_visual.to(device)</span>
<span class="c1">#</span>
<span class="c1">#     # !!! Important to set eval mode !!!</span>
<span class="c1">#     model_visual.eval()</span>
<span class="c1">#</span>
<span class="c1">#     criterion = torch.nn.CrossEntropyLoss()</span>
<span class="c1">#</span>
<span class="c1">#     batch_x, batch_y, *others = next(iter(data_loader))</span>
<span class="c1">#     batch_x = batch_x.to(device)</span>
<span class="c1">#     batch_y = batch_y.to(device)</span>
<span class="c1">#</span>
<span class="c1">#     if torch.__version__ &gt; &#39;1.8.1&#39;:</span>
<span class="c1">#         logging.info(&#39;Use self-defined function as an alternative for torch.eig since your torch&gt;=1.9&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         def old_torcheig(A, eigenvectors):</span>
<span class="c1">#             &#39;&#39;&#39;A temporary function as an alternative for torch.eig (torch&lt;1.9)&#39;&#39;&#39;</span>
<span class="c1">#             vals, vecs = torch.linalg.eig(A)</span>
<span class="c1">#             if torch.is_complex(vals) or torch.is_complex(vecs):</span>
<span class="c1">#                 logging.info(</span>
<span class="c1">#                     &#39;Warning: Complex values founded in Eigenvalues/Eigenvectors. This is impossible for real symmetric matrix like Hessian. \n We only keep the real part.&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             vals = torch.real(vals)</span>
<span class="c1">#             vecs = torch.real(vecs)</span>
<span class="c1">#</span>
<span class="c1">#             # vals is a nx2 matrix. see https://virtualgroup.cn/pytorch.org/docs/stable/generated/torch.eig.html</span>
<span class="c1">#             vals = vals.view(-1, 1) + torch.zeros(vals.size()[0], 2).to(vals.device)</span>
<span class="c1">#             if eigenvectors:</span>
<span class="c1">#                 return vals, vecs</span>
<span class="c1">#             else:</span>
<span class="c1">#                 return vals, torch.tensor([])</span>
<span class="c1">#</span>
<span class="c1">#         torch.eig = old_torcheig</span>
<span class="c1">#</span>
<span class="c1">#     # create the hessian computation module</span>
<span class="c1">#     hessian_comp = hessian(model_visual, criterion, data=(batch_x, batch_y), cuda=True)</span>
<span class="c1">#     # Now let&#39;s compute the top 2 eigenavlues and eigenvectors of the Hessian</span>
<span class="c1">#     top_eigenvalues, top_eigenvector = hessian_comp.eigenvalues(top_n=2, maxIter=1000)</span>
<span class="c1">#     logging.info(&quot;The top two eigenvalues of this model are: %.4f %.4f&quot; % (top_eigenvalues[0], top_eigenvalues[1]))</span>
<span class="c1">#</span>
<span class="c1">#     if save_path_for_hessian is not None:</span>
<span class="c1">#</span>
<span class="c1">#         density_eigen, density_weight = hessian_comp.density()</span>
<span class="c1">#</span>
<span class="c1">#         def get_esd_plot(eigenvalues, weights):</span>
<span class="c1">#             density, grids = density_generate(eigenvalues, weights)</span>
<span class="c1">#             plt.semilogy(grids, density + 1.0e-7)</span>
<span class="c1">#             plt.ylabel(&#39;Density (Log Scale)&#39;, fontsize=14, labelpad=10)</span>
<span class="c1">#             plt.xlabel(&#39;Eigenvlaue&#39;, fontsize=14, labelpad=10)</span>
<span class="c1">#             plt.xticks(fontsize=12)</span>
<span class="c1">#             plt.yticks(fontsize=12)</span>
<span class="c1">#             plt.axis([np.min(eigenvalues) - 1, np.max(eigenvalues) + 1, None, None])</span>
<span class="c1">#             return plt.gca()</span>
<span class="c1">#</span>
<span class="c1">#         def density_generate(eigenvalues,</span>
<span class="c1">#                              weights,</span>
<span class="c1">#                              num_bins=10000,</span>
<span class="c1">#                              sigma_squared=1e-5,</span>
<span class="c1">#                              overhead=0.01):</span>
<span class="c1">#             eigenvalues = np.array(eigenvalues)</span>
<span class="c1">#             weights = np.array(weights)</span>
<span class="c1">#</span>
<span class="c1">#             lambda_max = np.mean(np.max(eigenvalues, axis=1), axis=0) + overhead</span>
<span class="c1">#             lambda_min = np.mean(np.min(eigenvalues, axis=1), axis=0) - overhead</span>
<span class="c1">#</span>
<span class="c1">#             grids = np.linspace(lambda_min, lambda_max, num=num_bins)</span>
<span class="c1">#             sigma = sigma_squared * max(1, (lambda_max - lambda_min))</span>
<span class="c1">#</span>
<span class="c1">#             num_runs = eigenvalues.shape[0]</span>
<span class="c1">#             density_output = np.zeros((num_runs, num_bins))</span>
<span class="c1">#</span>
<span class="c1">#             for i in range(num_runs):</span>
<span class="c1">#                 for j in range(num_bins):</span>
<span class="c1">#                     x = grids[j]</span>
<span class="c1">#                     tmp_result = gaussian(eigenvalues[i, :], x, sigma)</span>
<span class="c1">#                     density_output[i, j] = np.sum(tmp_result * weights[i, :])</span>
<span class="c1">#             density = np.mean(density_output, axis=0)</span>
<span class="c1">#             normalization = np.sum(density) * (grids[1] - grids[0])</span>
<span class="c1">#             density = density / normalization</span>
<span class="c1">#             return density, grids</span>
<span class="c1">#</span>
<span class="c1">#         def gaussian(x, x0, sigma_squared):</span>
<span class="c1">#             return np.exp(-(x0 - x) ** 2 /</span>
<span class="c1">#                           (2.0 * sigma_squared)) / np.sqrt(2 * np.pi * sigma_squared)</span>
<span class="c1">#</span>
<span class="c1">#         ax = get_esd_plot(density_eigen, density_weight)</span>
<span class="c1">#</span>
<span class="c1">#         ax.set_title(f&#39;Max Eigen Value: {top_eigenvalues[0]:.2f}&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         plt.tight_layout()</span>
<span class="c1">#         plt.savefig(save_path_for_hessian)</span>
<span class="c1">#         plt.close()</span>
<span class="c1">#</span>
<span class="c1">#         logging.info(f&#39;Save to {save_path_for_hessian}&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     return top_eigenvalues</span>


<span class="k">class</span> <span class="nc">Bezier</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_bends</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bezier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
            <span class="s1">&#39;binom&#39;</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">binom</span><span class="p">(</span><span class="n">num_bends</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_bends</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_bends</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;rev_range&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">num_bends</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binom</span> <span class="o">*</span> \
               <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span> <span class="o">*</span> \
               <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rev_range</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PolyChain</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_bends</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PolyChain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_bends</span> <span class="o">=</span> <span class="n">num_bends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_bends</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">t_n</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bends</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">mcr_Trainer</span><span class="p">(</span><span class="n">BackdoorModelTrainer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">curve</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cruve</span> <span class="o">=</span> <span class="n">curve</span>

    <span class="k">def</span> <span class="nf">one_forward_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amp</span><span class="p">):</span>
            <span class="n">log_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_predict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">batch_loss</span><span class="p">,</span> <span class="n">batch_predict</span>

        <span class="k">return</span> <span class="n">batch_loss</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">sampleModelFromCurve</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>  <span class="c1"># the model to be sampled, parameter will be replaced by sampled weights from curve</span>
        <span class="n">curve_netCs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>  <span class="c1"># models used for represents a curve</span>
        <span class="n">curve_module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>  <span class="c1"># module that used to generate weights which sum to 1. e.g. Bezier, PolyChain</span>
        <span class="n">curve_t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># which point on curve will be sampled?</span>
        <span class="n">device</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="c1"># use given test_t to generate one model to do test</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">inter_netC</span> <span class="ow">in</span> <span class="n">curve_netCs</span><span class="p">:</span>  <span class="c1"># skip the start and end model</span>
        <span class="n">inter_netC</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">inter_netC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">lookupDict_for_netCs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">inter_netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">())</span> <span class="k">for</span> <span class="n">inter_netC</span> <span class="ow">in</span> <span class="n">curve_netCs</span><span class="p">]</span>
    <span class="n">inter_netC_coefs</span> <span class="o">=</span> <span class="n">curve_module</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">curve_t</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">inter_netC_idx</span><span class="p">,</span> <span class="n">lookupdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookupDict_for_netCs</span><span class="p">):</span>
                <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">+=</span> <span class="n">lookupdict</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">inter_netC_coefs</span><span class="p">[</span>
                    <span class="n">inter_netC_idx</span><span class="p">]</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                <span class="n">weighted_parameter_from_curve_netCs</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<div class="viewcode-block" id="mcr"><a class="viewcode-back" href="../../generated/defense.mcr.html#defense.mcr">[docs]</a><span class="k">class</span> <span class="nc">mcr</span><span class="p">(</span><span class="n">defense</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">mcr</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-pm&quot;</span><span class="p">,</span> <span class="s2">&quot;--pin_memory&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;dataloader pin_memory&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sgd_momentum&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--wd&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;weight decay of sgd&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--client_optimizer&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--amp&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">])</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--frequency_save&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39; frequency_save, 0 is never&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;cuda, cpu&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-nb&quot;</span><span class="p">,</span> <span class="s2">&quot;--non_blocking&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;.to(), set the non_blocking = ?&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dataset_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dataset&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;mnist, cifar10, gtsrb, celeba, tiny&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_classes&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input_height&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input_width&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input_channel&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr_scheduler&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the scheduler of lr&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--attack&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--poison_rate&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--target_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;all2one, all2all, cleanLabel&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--target_label&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--trigger_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;squareTrigger, gridTrigger, fourCornerTrigger, randomPixelTrigger, signalTrigger, trojanTrigger&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--model&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resnet18&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--random_seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;random seed&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--index&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;index of clean data&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--result_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the location of result&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_curve_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--yaml_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./config/defense/mcr/config.yaml&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the path of yaml&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_bends&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_t&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--curve&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ft_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ft_lr_scheduler&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># set the parameter for the fp defense</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ratio&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the ratio of clean data loader&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--acc_ratio&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the tolerance ration of the clean accuracy&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test_curve_every&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;frequency of testing the models on curve&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--load_other_model_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;instead of finetune the given poisoned model, we load other model from this part&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_clean_subset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use bd poison dataset as data poison for path training and BN update; or, use clean subset instead&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>

    <span class="k">def</span> <span class="nf">add_yaml_to_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">defaults</span>

    <span class="k">def</span> <span class="nf">process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">terminal_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
        <span class="n">args</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">get_num_classes</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_height</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input_width</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input_channel</span> <span class="o">=</span> <span class="n">get_input_shape</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_height</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input_width</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input_channel</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">args</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="s1">&#39;record/&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">result_file</span>
        <span class="n">defense_save_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">save_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;defense&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;mcr&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">defense_save_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">defense_save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">defense_save_path</span><span class="p">)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span> <span class="o">=</span> <span class="n">defense_save_path</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1">### set the logger</span>
        <span class="n">logFormatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)-8s</span><span class="s1">] [</span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">:%H:%M:%S&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># file Handler</span>
        <span class="n">fileHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
        <span class="n">fileHandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logFormatter</span><span class="p">)</span>
        <span class="n">fileHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fileHandler</span><span class="p">)</span>
        <span class="c1"># consoleHandler</span>
        <span class="n">consoleHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">consoleHandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logFormatter</span><span class="p">)</span>
        <span class="n">consoleHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">consoleHandler</span><span class="p">)</span>
        <span class="c1"># overall logger level should &lt;= min(handler) otherwise no log will be recorded.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># disable other debug, since too many debug</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;PIL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib.font_manager&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Only INFO or above level log will show in cmd. DEBUG level log only will show in log file.&quot;</span><span class="p">)</span>

        <span class="c1"># record the git infomation for debug (if available.)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">get_git_info</span><span class="p">()))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting git info fails.&#39;</span><span class="p">)</span>

        <span class="n">fix_random</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                load_dict = {</span>
<span class="sd">                        &#39;model_name&#39;: load_file[&#39;model_name&#39;],</span>
<span class="sd">                        &#39;model&#39;: load_file[&#39;model&#39;],</span>
<span class="sd">                        &#39;clean_train&#39;: clean_train_dataset_with_transform,</span>
<span class="sd">                        &#39;clean_test&#39; : clean_test_dataset_with_transform,</span>
<span class="sd">                        &#39;bd_train&#39;: bd_train_dataset_with_transform,</span>
<span class="sd">                        &#39;bd_test&#39;: bd_test_dataset_with_transform,</span>
<span class="sd">                    }</span>
<span class="sd">                &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attack_result</span> <span class="o">=</span> <span class="n">load_attack_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">save_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;attack_result.pt&#39;</span><span class="p">)</span>

        <span class="n">netC</span> <span class="o">=</span> <span class="n">generate_cls_model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>
        <span class="n">netC</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attack_result</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
        <span class="n">netC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">netC</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">netC</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">netC</span> <span class="o">=</span> <span class="n">netC</span>

    <span class="k">def</span> <span class="nf">defense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">netC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netC</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="n">attack_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attack_result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span>
                <span class="c1"># since DataParallel only allow .to(&quot;cuda&quot;)</span>
            <span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="p">)</span>

        <span class="c1"># clean_train with subset</span>
        <span class="n">clean_train_dataset_with_transform</span> <span class="o">=</span> <span class="n">attack_result</span><span class="p">[</span><span class="s1">&#39;clean_train&#39;</span><span class="p">]</span>
        <span class="n">clean_train_dataset_without_transform</span> <span class="o">=</span> <span class="n">clean_train_dataset_with_transform</span><span class="o">.</span><span class="n">wrapped_dataset</span>
        <span class="n">clean_train_dataset_without_transform</span> <span class="o">=</span> <span class="n">prepro_cls_DatasetBD_v2</span><span class="p">(</span>
            <span class="n">clean_train_dataset_without_transform</span>
        <span class="p">)</span>
        <span class="c1"># logging.warning(&quot;No subset is done, ONLY for test!!!!!&quot;)</span>
        <span class="n">ran_idx</span> <span class="o">=</span> <span class="n">choose_index</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_train_dataset_without_transform</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get ran_idx for subset clean train dataset, (len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ran_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">), ran_idx:</span><span class="si">{</span><span class="n">ran_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">clean_train_dataset_without_transform</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span>
            <span class="n">choose_index</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_train_dataset_without_transform</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">log_index</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;index.txt&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">log_index</span><span class="p">,</span> <span class="n">ran_idx</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">clean_train_dataset_with_transform</span><span class="o">.</span><span class="n">wrapped_dataset</span> <span class="o">=</span> <span class="n">clean_train_dataset_without_transform</span>
        <span class="n">clean_train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">clean_train_dataset_with_transform</span><span class="p">,</span>
                                                             <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                             <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                                                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">clean_test_dataset_with_transform</span> <span class="o">=</span> <span class="n">attack_result</span><span class="p">[</span><span class="s1">&#39;clean_test&#39;</span><span class="p">]</span>
        <span class="n">data_clean_testset</span> <span class="o">=</span> <span class="n">clean_test_dataset_with_transform</span>
        <span class="n">clean_test_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">data_clean_testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                            <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>

        <span class="n">bd_test_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">attack_result</span><span class="p">[</span><span class="s1">&#39;bd_test&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                         <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                         <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">)</span>

        <span class="n">bd_train_dataset_with_transform</span> <span class="o">=</span> <span class="n">attack_result</span><span class="p">[</span><span class="s1">&#39;bd_train&#39;</span><span class="p">]</span>
        <span class="n">bd_train_dataset_without_transform</span> <span class="o">=</span> <span class="n">bd_train_dataset_with_transform</span><span class="o">.</span><span class="n">wrapped_dataset</span>
        <span class="n">bd_train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">bd_train_dataset_with_transform</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">where_poisoned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">bd_train_dataset_without_transform</span><span class="o">.</span><span class="n">poison_indicator</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len of where_poisoned = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">where_poisoned</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bd_train_poisoned_part_wo_trans</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bd_train_dataset_without_transform</span><span class="p">)</span>
        <span class="n">bd_train_poisoned_part_wo_trans</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span>
            <span class="n">where_poisoned</span>
        <span class="p">)</span>
        <span class="n">bd_train_poisoned_part_w_trans</span> <span class="o">=</span> <span class="n">dataset_wrapper_with_transform</span><span class="p">(</span>
            <span class="n">bd_train_poisoned_part_wo_trans</span><span class="p">,</span>
            <span class="n">wrap_img_transform</span><span class="o">=</span><span class="n">clean_test_dataset_with_transform</span><span class="o">.</span><span class="n">wrap_img_transform</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bd_train_poisoned_part_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">bd_train_poisoned_part_w_trans</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">where_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">bd_train_dataset_without_transform</span><span class="o">.</span><span class="n">poison_indicator</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len of where_clean = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">where_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bd_train_clean_part_wo_trans</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bd_train_dataset_without_transform</span><span class="p">)</span>
        <span class="n">bd_train_clean_part_wo_trans</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span>
            <span class="n">where_clean</span>
        <span class="p">)</span>
        <span class="n">bd_train_clean_part_w_trans</span> <span class="o">=</span> <span class="n">dataset_wrapper_with_transform</span><span class="p">(</span>
            <span class="n">bd_train_clean_part_wo_trans</span><span class="p">,</span>
            <span class="n">wrap_img_transform</span><span class="o">=</span><span class="n">clean_test_dataset_with_transform</span><span class="o">.</span><span class="n">wrap_img_transform</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bd_train_clean_part_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">bd_train_clean_part_w_trans</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># finetune netC with clean data</span>
        <span class="n">ft_netC</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">netC</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;load_other_model_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">load_other_model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ft_netC</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">ft_netC</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

            <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
            <span class="n">ft_args</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">ft_args</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;ft_&#39;</span> <span class="ow">in</span> <span class="n">k</span>
            <span class="p">}</span>
            <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="n">argparser_opt_scheduler</span><span class="p">(</span>
                <span class="n">ft_netC</span><span class="p">,</span>
                <span class="n">ft_args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">finetune_trainer</span> <span class="o">=</span> <span class="n">BackdoorModelTrainer</span><span class="p">(</span>
                <span class="n">ft_netC</span>
            <span class="p">)</span>

            <span class="n">finetune_trainer</span><span class="o">.</span><span class="n">train_with_test_each_epoch_on_mix</span><span class="p">(</span>
                <span class="n">clean_train_dataloader</span><span class="p">,</span>
                <span class="n">clean_test_dataloader</span><span class="p">,</span>
                <span class="n">bd_test_dataloader</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">ft_epochs</span><span class="p">,</span>
                <span class="n">criterion</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">amp</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>

                <span class="n">args</span><span class="o">.</span><span class="n">frequency_save</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="p">,</span>
                <span class="s2">&quot;finetune&quot;</span><span class="p">,</span>

                <span class="n">prefetch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">prefetch_transform_attr_name</span><span class="o">=</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span>
                <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># load from load_other_model_path</span>
            <span class="n">ft_netC</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">load_other_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
            <span class="n">ft_netC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load alternative model from </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">load_other_model_path</span><span class="si">}</span><span class="s2">!!!!&quot;</span><span class="p">)</span>

        <span class="n">ft_netC</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">ft_netC</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

        <span class="c1"># train the curve</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;To align the training setting, we change the scheduler. If you want to change it back you can set it as below manually&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        def learning_rate_schedule(base_lr, epoch, total_epochs):</span>
<span class="sd">            alpha = epoch / total_epochs</span>
<span class="sd">            if alpha &lt;= 0.5:</span>
<span class="sd">                factor = 1.0</span>
<span class="sd">            elif alpha &lt;= 0.9:</span>
<span class="sd">                factor = 1.0 - (alpha - 0.5) / 0.4 * 0.99</span>
<span class="sd">            else:</span>
<span class="sd">                factor = 0.01</span>
<span class="sd">            return factor * base_lr</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">):</span>
            <span class="n">curve</span> <span class="o">=</span> <span class="n">Bezier</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_bends</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">):</span>
            <span class="n">curve</span> <span class="o">=</span> <span class="n">PolyChain</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_bends</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Unknown curve&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">netC</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">model_mix</span><span class="p">(</span><span class="n">netC</span><span class="p">,</span> <span class="n">weight1</span><span class="p">,</span> <span class="n">ft_netC</span><span class="p">,</span> <span class="n">weight2</span><span class="p">,</span> <span class="n">model_mix_init</span><span class="p">):</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">weight1</span><span class="p">,</span> <span class="n">weight2</span><span class="p">]</span>
            <span class="n">lookupDict_for_netCs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ft_netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">model_mix_init</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">inter_netC_idx</span><span class="p">,</span> <span class="n">lookupdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookupDict_for_netCs</span><span class="p">):</span>
                    <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">+=</span> <span class="n">lookupdict</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">coefs</span><span class="p">[</span>
                        <span class="n">inter_netC_idx</span><span class="p">]</span>
                <span class="n">parameter</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                    <span class="n">weighted_parameter_from_curve_netCs</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">model_mix_init</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        class simpleWeightNet(torch.nn.Module):</span>
<span class="sd">            def __init__(self, weight_value = None):</span>
<span class="sd">                super().__init__()</span>
<span class="sd">                self.weight_value = weight_value</span>
<span class="sd">                self.linear = torch.nn.Linear(5, 5)</span>
<span class="sd">                if self.weight_value is not None:</span>
<span class="sd">                    self.linear.weight.data = torch.tensor(weight_value).float()</span>
<span class="sd">                    self.linear.bias.data =  torch.tensor(weight_value).float()</span>
<span class="sd">                else:</span>
<span class="sd">                    print(</span>
<span class="sd">                        {&quot;self.linear.weight&quot;: self.linear.weight,</span>
<span class="sd">                         &quot;self.linear.bias&quot;: self.linear.bias, }</span>
<span class="sd">                    )</span>
<span class="sd">            def forward(self, x):</span>
<span class="sd">                return self.linear.weight, self.linear.bias, x</span>


<span class="sd">        a = model_mix(</span>
<span class="sd">                simpleWeightNet(1),</span>
<span class="sd">                0.5,</span>
<span class="sd">                simpleWeightNet(0.3),</span>
<span class="sd">                7,</span>
<span class="sd">               simpleWeightNet(),</span>
<span class="sd">        )</span>

<span class="sd">        print(a(1))</span>
<span class="sd">        print(a.linear.weight, a.linear.bias)</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        3 point -&gt; 1/2 + 1/2 (1 intermediate point)</span>
<span class="sd">        4 point -&gt; 1/3 + 1/3 + 1/3 (2 intermediate point)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">getWeightForIntermediatePoints</span><span class="p">(</span><span class="n">point_number</span><span class="p">,</span> <span class="n">nth_point</span><span class="p">):</span>
            <span class="n">one_weight_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">point_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nth_point</span><span class="p">)</span> <span class="o">*</span> <span class="n">one_weight_part</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">nth_point</span><span class="p">)</span> <span class="o">*</span> <span class="n">one_weight_part</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;getWeightForIntermediatePoints(4, 1)</span>
<span class="sd">        (0.3333333333333333, 0.6666666666666667)</span>
<span class="sd">        getWeightForIntermediatePoints(4, 2)</span>
<span class="sd">        (0.6666666666666666, 0.33333333333333337)&#39;&#39;&#39;</span>

        <span class="n">curve_netCs</span> <span class="o">=</span> <span class="p">[</span>
                          <span class="n">deepcopy</span><span class="p">(</span><span class="n">netC</span><span class="p">)</span>
                      <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_bends</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># init the intermediate models on curve</span>

        <span class="c1"># do model mix without modify the original model</span>
        <span class="k">for</span> <span class="n">intermediate_curve_netC_idx</span><span class="p">,</span> <span class="n">intermediate_curve_netC</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">curve_netCs</span><span class="p">):</span>
            <span class="n">intermediate_curve_netC_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">weight_left</span><span class="p">,</span> <span class="n">weight_right</span> <span class="o">=</span> <span class="n">getWeightForIntermediatePoints</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">curve_netCs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                                                       <span class="n">intermediate_curve_netC_idx</span><span class="p">)</span>
            <span class="n">curve_netCs</span><span class="p">[</span><span class="n">intermediate_curve_netC_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_mix</span><span class="p">(</span><span class="n">netC</span><span class="p">,</span> <span class="n">weight_left</span><span class="p">,</span> <span class="n">ft_netC</span><span class="p">,</span> <span class="n">weight_right</span><span class="p">,</span>
                                                                     <span class="n">intermediate_curve_netC</span><span class="p">)</span>

        <span class="n">curve_netCs_optimizers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve_netCs_schedulers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">intermediate_curve_netC</span> <span class="ow">in</span> <span class="n">curve_netCs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">netC</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">parameter</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">intermediate_curve_netC_opt</span><span class="p">,</span> <span class="n">intermediate_curve_netC_scheduler</span> <span class="o">=</span> <span class="n">argparser_opt_scheduler</span><span class="p">(</span>
                <span class="n">intermediate_curve_netC</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">curve_netCs_optimizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intermediate_curve_netC_opt</span><span class="p">)</span>
            <span class="n">curve_netCs_schedulers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intermediate_curve_netC_scheduler</span><span class="p">)</span>

        <span class="n">curve_netCs</span> <span class="o">=</span> <span class="p">[</span><span class="n">netC</span><span class="p">]</span> <span class="o">+</span> <span class="n">curve_netCs</span> <span class="o">+</span> <span class="p">[</span><span class="n">ft_netC</span><span class="p">]</span>  <span class="c1"># add the start and end model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_netCs</span> <span class="o">=</span> <span class="n">curve_netCs</span>

        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

        <span class="c1"># just for aggregation</span>
        <span class="n">new_netC_for_train_curve_aggregation</span> <span class="o">=</span> <span class="n">generate_cls_model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>
        <span class="n">new_netC_optimizer</span><span class="p">,</span> <span class="n">new_netC_scheduler</span> <span class="o">=</span> <span class="n">argparser_opt_scheduler</span><span class="p">(</span>
            <span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Before start training, just like the original paper, test for clean test error difference. see if two model have difference in sample classified wrongly&quot;</span><span class="p">)</span>
        <span class="n">m1_metrics</span><span class="p">,</span> <span class="n">m1_predicts</span><span class="p">,</span> <span class="n">m1_targets</span> <span class="o">=</span> <span class="n">given_dataloader_test</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">netC</span><span class="p">,</span>
            <span class="n">test_dataloader</span><span class="o">=</span><span class="n">clean_test_dataloader</span><span class="p">,</span>
            <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
            <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m1_metric=</span><span class="si">{</span><span class="n">m1_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">m1_wrong</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1_predicts</span> <span class="o">!=</span> <span class="n">m1_targets</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">m2_metrics</span><span class="p">,</span> <span class="n">m2_predicts</span><span class="p">,</span> <span class="n">m2_targets</span> <span class="o">=</span> <span class="n">given_dataloader_test</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">ft_netC</span><span class="p">,</span>
            <span class="n">test_dataloader</span><span class="o">=</span><span class="n">clean_test_dataloader</span><span class="p">,</span>
            <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
            <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m2_metric=</span><span class="si">{</span><span class="n">m2_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">m2_wrong</span> <span class="o">=</span> <span class="p">(</span><span class="n">m2_predicts</span> <span class="o">!=</span> <span class="n">m2_targets</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># both m1, m2 wrong</span>
        <span class="n">m1_m2_wrong</span> <span class="o">=</span> <span class="n">m1_wrong</span> <span class="o">*</span> <span class="n">m2_wrong</span>

        <span class="n">m1_wrong_only</span> <span class="o">=</span> <span class="n">m1_wrong</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1_m2_wrong</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">m2_wrong_only</span> <span class="o">=</span> <span class="n">m2_wrong</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1_m2_wrong</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;m1_wrong num = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m1_wrong</span><span class="p">)</span><span class="si">}</span><span class="s2">, m2_wrong num = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m2_wrong</span><span class="p">)</span><span class="si">}</span><span class="s2">, m1m2wrong = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m1_m2_wrong</span><span class="p">)</span><span class="si">}</span><span class="s2">, m1_wrong only = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m1_wrong_only</span><span class="p">)</span><span class="si">}</span><span class="s2">, m2_wrong only = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m2_wrong_only</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test_t</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">test_t_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">test_t</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test_t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">test_t_list</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_t_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;We use the following test_t_list: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_t_list</span><span class="p">))</span>

        <span class="n">curve_record_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for different test_t value used.</span>

        <span class="k">if</span> <span class="s2">&quot;use_clean_subset&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">use_clean_subset</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dataloader_given</span> <span class="o">=</span> <span class="n">clean_train_dataloader</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Use clean_train_dataloader to train curve_netCs, data sample num = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataloader_given</span> <span class="o">=</span> <span class="n">bd_train_dataloader</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Use bd_train_dataloader to train curve_netCs, data sample num = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bd_train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">test_t</span> <span class="ow">in</span> <span class="n">test_t_list</span><span class="p">:</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># curve_record_dict[test_t][&quot;clean_top0_eigenvalue_list&quot;] = []</span>
            <span class="c1"># curve_record_dict[test_t][&quot;bd_top0_eigenvalue_list&quot;] = []</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;clean_test_loss_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_test_loss_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_acc_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_asr_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_ra_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;train_loss_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metric_Aggregator</span><span class="p">()</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_clean_part_test_loss_avg_over_batch_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_clean_part_acc_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_loss_avg_over_batch_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_asr_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_ra_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># curve_record_dict[test_t][&quot;clean_part_generalization_gap_list&quot;] = []</span>
            <span class="c1"># curve_record_dict[test_t][&quot;poison_part_generalization_gap_list&quot;] = []</span>

        <span class="c1"># os.makedirs(</span>
        <span class="c1">#     os.path.join(args.defense_save_path, &quot;hessian_plot&quot;),</span>
        <span class="c1">#     exist_ok=True,</span>
        <span class="c1"># )</span>

        <span class="k">for</span> <span class="n">epoch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_curve_epochs</span><span class="p">):</span>

            <span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">new_netC_optimizer</span><span class="p">,</span> <span class="n">new_netC_scheduler</span><span class="p">,</span> <span class="n">curve_netCs</span><span class="p">,</span> <span class="n">curve_netCs_optimizers</span><span class="p">,</span> \
            <span class="n">curve_netCs_schedulers</span><span class="p">,</span> <span class="n">one_epoch_train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_curve_one_epoch</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">new_netC_optimizer</span><span class="p">,</span> <span class="n">new_netC_scheduler</span><span class="p">,</span> <span class="n">curve_netCs</span><span class="p">,</span>
                <span class="n">curve_netCs_optimizers</span><span class="p">,</span>
                <span class="n">curve_netCs_schedulers</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">dataloader_given</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># # use given test_t to generate one model to do test</span>
            <span class="c1"># new_netC_for_train_curve_aggregation.eval()</span>
            <span class="c1"># new_netC_for_train_curve_aggregation.to(self.device)</span>
            <span class="c1">#</span>
            <span class="c1"># for inter_netC in curve_netCs:  # skip the start and end model</span>
            <span class="c1">#     inter_netC.eval()</span>
            <span class="c1">#     inter_netC.to(self.device)</span>
            <span class="c1">#</span>
            <span class="c1"># lookupDict_for_netCs = [dict(inter_netC.named_parameters()) for inter_netC in curve_netCs]</span>
            <span class="c1"># inter_netC_coefs = curve(torch.tensor(args.test_t))</span>
            <span class="c1"># with torch.no_grad():</span>
            <span class="c1">#     for parameter_name, parameter in new_netC_for_train_curve_aggregation.named_parameters():</span>
            <span class="c1">#         weighted_parameter_from_curve_netCs = 0</span>
            <span class="c1">#         for inter_netC_idx, lookupdict in enumerate(lookupDict_for_netCs):</span>
            <span class="c1">#             weighted_parameter_from_curve_netCs += lookupdict[parameter_name].data * inter_netC_coefs[</span>
            <span class="c1">#                 inter_netC_idx]</span>
            <span class="c1">#         parameter.copy_(</span>
            <span class="c1">#             weighted_parameter_from_curve_netCs</span>
            <span class="c1">#         )</span>

            <span class="k">if</span> <span class="n">epoch_idx</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">test_curve_every</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_curve_every</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="s2"> is finished, now test the model on clean and bd test set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch_idx</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">test_t</span> <span class="ow">in</span> <span class="n">test_t_list</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now test the model on test_t = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_t</span><span class="p">))</span>

                <span class="c1"># NOTE THAT THEY ARE ALL THE SAME !!!!!!</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;train_loss_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_epoch_train_loss</span><span class="p">)</span>

                <span class="n">new_netC_for_train_curve_aggregation</span> <span class="o">=</span> <span class="n">sampleModelFromCurve</span><span class="p">(</span>
                    <span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
                    <span class="n">curve_netCs</span><span class="p">,</span>
                    <span class="n">curve</span><span class="p">,</span>
                    <span class="n">test_t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># find the first batchnorm layer in model&#39;s named_modules</span>
                <span class="c1"># first_BN = None</span>
                <span class="c1"># for name, module in new_netC_for_train_curve_aggregation.named_modules():</span>
                <span class="c1">#     if isinstance(module, torch.nn.BatchNorm2d):</span>
                <span class="c1">#         first_BN = module</span>
                <span class="c1">#         break</span>
                <span class="c1"># if first_BN is not None:</span>
                <span class="c1">#     logging.info(f&quot;Before go through train dataset, first_BN.running_mean = {first_BN.running_mean}&quot;)</span>
                <span class="c1">#     logging.info(f&quot;Before go through train dataset, first_BN.running_var = {first_BN.running_var}&quot;)</span>

                <span class="n">new_netC_for_train_curve_aggregation</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">additional_info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader_given</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">)</span>
                        <span class="n">new_netC_for_train_curve_aggregation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="c1"># first_BN = None</span>
                <span class="c1"># for name, module in new_netC_for_train_curve_aggregation.named_modules():</span>
                <span class="c1">#     if isinstance(module, torch.nn.BatchNorm2d):</span>
                <span class="c1">#         first_BN = module</span>
                <span class="c1">#         break</span>
                <span class="c1"># if first_BN is not None:</span>
                <span class="c1">#     logging.info(f&quot;After go through train dataset, first_BN.running_mean = {first_BN.running_mean}&quot;)</span>
                <span class="c1">#     logging.info(f&quot;After go through train dataset, first_BN.running_var = {first_BN.running_var}&quot;)</span>
                <span class="n">new_netC_for_train_curve_aggregation</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

                <span class="n">bd_train_clean_part_metrics</span><span class="p">,</span> \
                <span class="n">bd_train_clean_part_test_epoch_predict_list</span><span class="p">,</span> \
                <span class="n">bd_train_clean_part_test_epoch_label_list</span><span class="p">,</span> \
                    <span class="o">=</span> <span class="n">given_dataloader_test</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
                    <span class="n">test_dataloader</span><span class="o">=</span><span class="n">bd_train_clean_part_dataloader</span><span class="p">,</span>
                    <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                    <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">bd_train_clean_part_test_loss_avg_over_batch</span> <span class="o">=</span> <span class="n">bd_train_clean_part_metrics</span><span class="p">[</span><span class="s2">&quot;test_loss_avg_over_batch&quot;</span><span class="p">]</span>
                <span class="n">bd_train_clean_part_acc</span> <span class="o">=</span> <span class="n">bd_train_clean_part_metrics</span><span class="p">[</span><span class="s2">&quot;test_acc&quot;</span><span class="p">]</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_clean_part_test_loss_avg_over_batch_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">bd_train_clean_part_test_loss_avg_over_batch</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_clean_part_acc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bd_train_clean_part_acc</span><span class="p">)</span>

                <span class="n">bd_train_poisoned_part_metrics</span><span class="p">,</span> \
                <span class="n">bd_train_poisoned_part_epoch_predict_list</span><span class="p">,</span> \
                <span class="n">bd_train_poisoned_part_epoch_label_list</span><span class="p">,</span> \
                <span class="n">bd_train_poisoned_part_epoch_original_index_list</span><span class="p">,</span> \
                <span class="n">bd_train_poisoned_part_epoch_poison_indicator_list</span><span class="p">,</span> \
                <span class="n">bd_train_poisoned_part_epoch_original_targets_list</span> <span class="o">=</span> <span class="n">test_given_dataloader_on_mix</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
                    <span class="n">test_dataloader</span><span class="o">=</span><span class="n">bd_train_poisoned_part_dataloader</span><span class="p">,</span>
                    <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                    <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">bd_train_poisoned_part_loss_avg_over_batch</span> <span class="o">=</span> <span class="n">bd_train_poisoned_part_metrics</span><span class="p">[</span><span class="s2">&quot;test_loss_avg_over_batch&quot;</span><span class="p">]</span>
                <span class="n">bd_train_poisoned_part_asr</span> <span class="o">=</span> <span class="n">all_acc</span><span class="p">(</span><span class="n">bd_train_poisoned_part_epoch_predict_list</span><span class="p">,</span>
                                                     <span class="n">bd_train_poisoned_part_epoch_label_list</span><span class="p">)</span>
                <span class="n">bd_train_poisoned_part_ra</span> <span class="o">=</span> <span class="n">all_acc</span><span class="p">(</span><span class="n">bd_train_poisoned_part_epoch_predict_list</span><span class="p">,</span>
                                                    <span class="n">bd_train_poisoned_part_epoch_original_targets_list</span><span class="p">)</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_loss_avg_over_batch_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">bd_train_poisoned_part_loss_avg_over_batch</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_asr_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bd_train_poisoned_part_asr</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_ra_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bd_train_poisoned_part_ra</span><span class="p">)</span>

                <span class="n">clean_metrics</span><span class="p">,</span> \
                <span class="n">clean_test_epoch_predict_list</span><span class="p">,</span> \
                <span class="n">clean_test_epoch_label_list</span><span class="p">,</span> \
                    <span class="o">=</span> <span class="n">given_dataloader_test</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
                    <span class="n">test_dataloader</span><span class="o">=</span><span class="n">clean_test_dataloader</span><span class="p">,</span>
                    <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                    <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">clean_test_loss_avg_over_batch</span> <span class="o">=</span> <span class="n">clean_metrics</span><span class="p">[</span><span class="s2">&quot;test_loss_avg_over_batch&quot;</span><span class="p">]</span>
                <span class="n">test_acc</span> <span class="o">=</span> <span class="n">clean_metrics</span><span class="p">[</span><span class="s2">&quot;test_acc&quot;</span><span class="p">]</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;clean_test_loss_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_test_loss_avg_over_batch</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_acc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_acc</span><span class="p">)</span>

                <span class="n">bd_metrics</span><span class="p">,</span> \
                <span class="n">bd_test_epoch_predict_list</span><span class="p">,</span> \
                <span class="n">bd_test_epoch_label_list</span><span class="p">,</span> \
                <span class="n">bd_test_epoch_original_index_list</span><span class="p">,</span> \
                <span class="n">bd_test_epoch_poison_indicator_list</span><span class="p">,</span> \
                <span class="n">bd_test_epoch_original_targets_list</span> <span class="o">=</span> <span class="n">test_given_dataloader_on_mix</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">new_netC_for_train_curve_aggregation</span><span class="p">,</span>
                    <span class="n">test_dataloader</span><span class="o">=</span><span class="n">bd_test_dataloader</span><span class="p">,</span>
                    <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
                    <span class="n">non_blocking</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">bd_test_loss_avg_over_batch</span> <span class="o">=</span> <span class="n">bd_metrics</span><span class="p">[</span><span class="s2">&quot;test_loss_avg_over_batch&quot;</span><span class="p">]</span>
                <span class="n">test_asr</span> <span class="o">=</span> <span class="n">all_acc</span><span class="p">(</span><span class="n">bd_test_epoch_predict_list</span><span class="p">,</span> <span class="n">bd_test_epoch_label_list</span><span class="p">)</span>
                <span class="n">test_ra</span> <span class="o">=</span> <span class="n">all_acc</span><span class="p">(</span><span class="n">bd_test_epoch_predict_list</span><span class="p">,</span> <span class="n">bd_test_epoch_original_targets_list</span><span class="p">)</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_test_loss_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bd_test_loss_avg_over_batch</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_asr_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_asr</span><span class="p">)</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_ra_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_ra</span><span class="p">)</span>

                <span class="c1"># clean_top_eigenvalues = plot_hessian_eigenvalues(</span>
                <span class="c1">#     model_visual=new_netC_for_train_curve_aggregation,</span>
                <span class="c1">#     data_loader=clean_test_dataloader,</span>
                <span class="c1">#     device=self.device,</span>
                <span class="c1">#     # save_path_for_hessian = os.path.join(args.defense_save_path, &quot;hessian_plot&quot;, &quot;clean_hessian_eigenvalues_{}_{}.png&quot;.format(epoch_idx, test_t)),</span>
                <span class="c1"># )</span>
                <span class="c1"># clean_top0_eigenvalue = clean_top_eigenvalues[0]</span>
                <span class="c1">#</span>
                <span class="c1"># curve_record_dict[test_t][&quot;clean_top0_eigenvalue_list&quot;].append(clean_top0_eigenvalue)</span>
                <span class="c1">#</span>
                <span class="c1"># bd_top_eigenvalues = plot_hessian_eigenvalues(</span>
                <span class="c1">#     model_visual=new_netC_for_train_curve_aggregation,</span>
                <span class="c1">#     data_loader=bd_test_dataloader,</span>
                <span class="c1">#     device=self.device,</span>
                <span class="c1">#     # save_path_for_hessian=os.path.join(args.defense_save_path, &quot;hessian_plot&quot;, &quot;bd_hessian_eigenvalues_{}_{}.png&quot;.format(epoch_idx, test_t)),</span>
                <span class="c1"># )</span>
                <span class="c1"># bd_top0_eigenvalue = bd_top_eigenvalues[0]</span>
                <span class="c1">#</span>
                <span class="c1"># curve_record_dict[test_t][&quot;bd_top0_eigenvalue_list&quot;].append(bd_top0_eigenvalue)</span>
                <span class="c1">#</span>
                <span class="c1"># curve_record_dict[test_t][&quot;clean_part_generalization_gap_list&quot;].append(</span>
                <span class="c1">#     bd_train_clean_part_acc - test_acc)</span>
                <span class="c1"># curve_record_dict[test_t][&quot;poison_part_generalization_gap_list&quot;].append(</span>
                <span class="c1">#     bd_train_poisoned_part_asr - test_asr)</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">](</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch_idx</span><span class="p">,</span>
                        <span class="s2">&quot;test_t&quot;</span><span class="p">:</span> <span class="n">test_t</span><span class="p">,</span>
                        <span class="s2">&quot;train_epoch_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">one_epoch_train_loss</span><span class="p">,</span>
                        <span class="s2">&quot;clean_test_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">clean_test_loss_avg_over_batch</span><span class="p">,</span>
                        <span class="s2">&quot;bd_test_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">bd_test_loss_avg_over_batch</span><span class="p">,</span>
                        <span class="s2">&quot;test_acc&quot;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
                        <span class="s2">&quot;test_asr&quot;</span><span class="p">:</span> <span class="n">test_asr</span><span class="p">,</span>
                        <span class="s2">&quot;test_ra&quot;</span><span class="p">:</span> <span class="n">test_ra</span><span class="p">,</span>
                        <span class="c1"># &quot;clean_top0_eigenvalue&quot;: clean_top0_eigenvalue,</span>
                        <span class="c1"># &quot;bd_top0_eigenvalue&quot;: bd_top0_eigenvalue,</span>
                        <span class="s2">&quot;bd_train_clean_part_test_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">bd_train_clean_part_test_loss_avg_over_batch</span><span class="p">,</span>
                        <span class="s2">&quot;bd_train_clean_part_acc&quot;</span><span class="p">:</span> <span class="n">bd_train_clean_part_acc</span><span class="p">,</span>
                        <span class="s2">&quot;bd_train_poisoned_part_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">bd_train_poisoned_part_loss_avg_over_batch</span><span class="p">,</span>
                        <span class="s2">&quot;bd_train_poisoned_part_asr&quot;</span><span class="p">:</span> <span class="n">bd_train_poisoned_part_asr</span><span class="p">,</span>
                        <span class="s2">&quot;bd_train_poisoned_part_ra&quot;</span><span class="p">:</span> <span class="n">bd_train_poisoned_part_ra</span><span class="p">,</span>
                        <span class="c1"># &quot;clean_part_generalization_gap&quot;: bd_train_clean_part_acc - test_acc,</span>
                        <span class="c1"># &quot;poison_part_generalization_gap&quot;: bd_train_poisoned_part_asr - test_asr,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># for bd train different part</span>
                <span class="n">general_plot_for_epoch</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;bd_train_clean_part_test_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span>
                            <span class="s2">&quot;bd_train_clean_part_test_loss_avg_over_batch_list&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;bd_train_poisoned_part_loss_avg_over_batch&quot;</span><span class="p">:</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span>
                            <span class="s2">&quot;bd_train_poisoned_part_loss_avg_over_batch_list&quot;</span><span class="p">],</span>
                    <span class="p">},</span>
                    <span class="n">save_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s2">/t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">_bd_train_parts_loss.png&quot;</span><span class="p">,</span>
                    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">general_plot_for_epoch</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;bd_train_clean_part_acc&quot;</span><span class="p">:</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_clean_part_acc_list&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;bd_train_poisoned_part_asr&quot;</span><span class="p">:</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_asr_list&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;bd_train_poisoned_part_ra&quot;</span><span class="p">:</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_train_poisoned_part_ra_list&quot;</span><span class="p">],</span>
                        <span class="c1"># &quot;clean_part_generalization_gap&quot;: curve_record_dict[test_t][</span>
                        <span class="c1">#     &quot;clean_part_generalization_gap_list&quot;],</span>
                        <span class="c1"># &quot;poisoned_part_generalization_gap&quot;: curve_record_dict[test_t][</span>
                        <span class="c1">#     &quot;poison_part_generalization_gap_list&quot;],</span>
                    <span class="p">},</span>
                    <span class="n">save_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s2">/t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">_bd_train_parts_acc_like.png&quot;</span><span class="p">,</span>
                    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># for bd_test and clean_test</span>
                <span class="n">plot_loss</span><span class="p">(</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;train_loss_list&quot;</span><span class="p">],</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;clean_test_loss_list&quot;</span><span class="p">],</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;bd_test_loss_list&quot;</span><span class="p">],</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;curve_test_loss_metric_plots_t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">test_curve_every</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">plot_acc_like_metric</span><span class="p">(</span>
                    <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_acc_list&quot;</span><span class="p">],</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_asr_list&quot;</span><span class="p">],</span>
                    <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;test_ra_list&quot;</span><span class="p">],</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;curve_test_acc_like_metric_plots_t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">test_curve_every</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># plot</span>
                <span class="c1"># fix test_t on the curve path, compare loss and eigenvalue along time</span>

                <span class="c1"># t = np.arange(len(curve_record_dict[test_t][&quot;clean_top0_eigenvalue_list&quot;]))</span>
                <span class="c1"># data1 = curve_record_dict[test_t][&quot;clean_top0_eigenvalue_list&quot;]</span>
                <span class="c1"># data2 = curve_record_dict[test_t][&quot;clean_part_generalization_gap_list&quot;]</span>
                <span class="c1"># data3 = curve_record_dict[test_t][&quot;poison_part_generalization_gap_list&quot;]</span>
                <span class="c1"># data4 = curve_record_dict[test_t][&quot;bd_top0_eigenvalue_list&quot;]</span>
                <span class="c1">#</span>
                <span class="c1"># fig, ax1 = plt.subplots()</span>
                <span class="c1">#</span>
                <span class="c1"># color = &#39;tab:red&#39;</span>
                <span class="c1"># ax1.set_xlabel(&#39;epoch&#39;)</span>
                <span class="c1"># ax1.set_ylabel(&#39;clean_top0_eigenvalue_list&#39;, color=color)</span>
                <span class="c1"># ax1.plot(t, data1, color=color)</span>
                <span class="c1"># ax1.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
                <span class="c1">#</span>
                <span class="c1"># ax2 = ax1.twinx()  # instantiate a second axes that shares the same x-axis</span>
                <span class="c1">#</span>
                <span class="c1"># color = &#39;tab:blue&#39;</span>
                <span class="c1"># ax2.set_ylabel(&#39;clean_part_generalization_gap&#39;, color=color)  # we already handled the x-label with ax1</span>
                <span class="c1"># ax2.plot(t, data2, color=color)</span>
                <span class="c1"># ax2.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
                <span class="c1">#</span>
                <span class="c1"># fig.tight_layout()  # otherwise the right y-label is slightly clipped</span>
                <span class="c1"># plt.savefig(f&quot;{args.defense_save_path}/t_{test_t}_clean_top0_eigenvalue_list.png&quot;, )</span>
                <span class="c1"># plt.close()</span>
                <span class="c1">#</span>
                <span class="c1"># fig, ax1 = plt.subplots()</span>
                <span class="c1">#</span>
                <span class="c1"># color = &#39;tab:green&#39;</span>
                <span class="c1"># ax1.set_xlabel(&#39;epoch&#39;)</span>
                <span class="c1"># ax1.set_ylabel(&#39;bd_part_generalization_gap&#39;, color=color)  # we already handled the x-label with ax1</span>
                <span class="c1"># ax1.plot(t, data3, color=color)</span>
                <span class="c1"># ax1.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
                <span class="c1">#</span>
                <span class="c1"># ax4 = ax1.twinx()  # instantiate a second axes that shares the same x-axis</span>
                <span class="c1"># color = &#39;tab:orange&#39;</span>
                <span class="c1"># ax4.set_ylabel(&#39;bd_top0_eigenvalue_list&#39;, color=color)  # we already handled the x-label with ax1</span>
                <span class="c1"># ax4.plot(t, data4, color=color)</span>
                <span class="c1"># ax4.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
                <span class="c1">#</span>
                <span class="c1"># fig.tight_layout()  # otherwise the right y-label is slightly clipped</span>
                <span class="c1"># plt.savefig(f&quot;{args.defense_save_path}/t_{test_t}_bd_top0_eigenvalue_list.png&quot;, )</span>
                <span class="c1"># plt.close()</span>

                <span class="c1"># general_plot_for_epoch(</span>
                <span class="c1">#     {</span>
                <span class="c1">#         # &quot;train_loss_list&quot;: curve_record_dict[test_t][&quot;train_loss_list&quot;],</span>
                <span class="c1">#         &quot;clean_test_loss_list&quot;: curve_record_dict[test_t][&quot;clean_test_loss_list&quot;],</span>
                <span class="c1">#         &quot;bd_test_loss_list&quot;: curve_record_dict[test_t][&quot;bd_test_loss_list&quot;],</span>
                <span class="c1">#         &quot;top0_eigenvalue_list&quot;:curve_record_dict[test_t][&quot;top0_eigenvalue_list&quot;],</span>
                <span class="c1">#     },</span>
                <span class="c1">#     save_path=f&quot;{args.defense_save_path}/t_{test_t}_top0_eigenvalue_list.png&quot;,</span>
                <span class="c1">#     ylabel=&quot;value&quot;,</span>
                <span class="c1"># )</span>

                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s2">/curve_train_df_t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

            <span class="c1"># # plot the clean_top0_eigenvalue_list and bd_top0_eigenvalue_list  for different test_t</span>
            <span class="c1"># same_epoch_clean_top0_eigenvalue_list = []</span>
            <span class="c1"># same_epoch_clean_part_generalization_gap_list = []</span>
            <span class="c1"># same_epoch_bd_part_generalization_gap_list = []</span>
            <span class="c1"># same_epoch_bd_top0_eigenvalue_list = []</span>
            <span class="c1"># for test_t in test_t_list:</span>
            <span class="c1">#     same_epoch_clean_top0_eigenvalue_list.append(</span>
            <span class="c1">#         curve_record_dict[test_t][&quot;clean_top0_eigenvalue_list&quot;][-1])</span>
            <span class="c1">#     same_epoch_clean_part_generalization_gap_list.append(</span>
            <span class="c1">#         curve_record_dict[test_t][&quot;clean_part_generalization_gap_list&quot;][-1]</span>
            <span class="c1">#     )</span>
            <span class="c1">#     same_epoch_bd_part_generalization_gap_list.append(</span>
            <span class="c1">#         curve_record_dict[test_t][&quot;poison_part_generalization_gap_list&quot;][-1]</span>
            <span class="c1">#     )</span>
            <span class="c1">#     same_epoch_bd_top0_eigenvalue_list.append(curve_record_dict[test_t][&quot;bd_top0_eigenvalue_list&quot;][-1])</span>

            <span class="c1"># t = np.arange(len(same_epoch_clean_top0_eigenvalue_list) + 1)[1:] / (</span>
            <span class="c1">#             len(same_epoch_clean_top0_eigenvalue_list) + 1)</span>
            <span class="c1"># data1 = same_epoch_clean_top0_eigenvalue_list</span>
            <span class="c1"># data2 = same_epoch_clean_part_generalization_gap_list</span>
            <span class="c1"># data3 = same_epoch_bd_part_generalization_gap_list</span>
            <span class="c1"># data4 = same_epoch_bd_top0_eigenvalue_list</span>
            <span class="c1">#</span>
            <span class="c1"># fig, ax1 = plt.subplots()</span>
            <span class="c1">#</span>
            <span class="c1"># color = &#39;tab:red&#39;</span>
            <span class="c1"># ax1.set_xlabel(&#39;test_t on curve path&#39;)</span>
            <span class="c1"># ax1.set_ylabel(&#39;same_epoch_clean_top0_eigenvalue_list&#39;, color=color)</span>
            <span class="c1"># ax1.plot(t, data1, color=color)</span>
            <span class="c1"># ax1.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
            <span class="c1">#</span>
            <span class="c1"># ax2 = ax1.twinx()  # instantiate a second axes that shares the same x-axis</span>
            <span class="c1">#</span>
            <span class="c1"># color = &#39;tab:blue&#39;</span>
            <span class="c1"># ax2.set_ylabel(&#39;same_epoch_clean_part_generalization_gap_list&#39;,</span>
            <span class="c1">#                color=color)  # we already handled the x-label with ax1</span>
            <span class="c1"># ax2.plot(t, data2, color=color)</span>
            <span class="c1"># ax2.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
            <span class="c1">#</span>
            <span class="c1"># fig.tight_layout()  # otherwise the right y-label is slightly clipped</span>
            <span class="c1"># plt.savefig(f&quot;{args.defense_save_path}/epoch_{epoch_idx}_clean_path.png&quot;, )</span>
            <span class="c1"># plt.close()</span>
            <span class="c1">#</span>
            <span class="c1"># fig, ax1 = plt.subplots()</span>
            <span class="c1">#</span>
            <span class="c1"># color = &#39;tab:green&#39;</span>
            <span class="c1"># ax1.set_xlabel(&#39;test_t on curve path&#39;)</span>
            <span class="c1"># ax1.set_ylabel(&#39;same_epoch_bd_part_generalization_gap_list&#39;,</span>
            <span class="c1">#                color=color)  # we already handled the x-label with ax1</span>
            <span class="c1"># ax1.plot(t, data3, color=color)</span>
            <span class="c1"># ax1.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
            <span class="c1">#</span>
            <span class="c1"># ax4 = ax1.twinx()  # instantiate a second axes that shares the same x-axis</span>
            <span class="c1"># color = &#39;tab:orange&#39;</span>
            <span class="c1"># ax4.set_ylabel(&#39;same_epoch_bd_top0_eigenvalue_list&#39;, color=color)  # we already handled the x-label with ax1</span>
            <span class="c1"># ax4.plot(t, data4, color=color)</span>
            <span class="c1"># ax4.tick_params(axis=&#39;y&#39;, labelcolor=color)</span>
            <span class="c1">#</span>
            <span class="c1"># fig.tight_layout()  # otherwise the right y-label is slightly clipped</span>
            <span class="c1"># plt.savefig(f&quot;{args.defense_save_path}/epoch_{epoch_idx}_bd_path.png&quot;, )</span>
            <span class="c1"># plt.close()</span>

            <span class="k">for</span> <span class="n">test_t</span> <span class="ow">in</span> <span class="n">test_t_list</span><span class="p">:</span>
                <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">test_t</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s2">/curve_train_df_summary_t_</span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="mf">0.1</span> <span class="ow">in</span> <span class="n">test_t_list</span><span class="p">:</span>
            <span class="n">final_t</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;0.1 is not in test_t_list, so we find the nearest value to 0.1 for final report result&quot;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">find_nearest</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="c1"># thanks to https://stackoverflow.com/questions/2566412/find-nearest-value-in-numpy-array</span>
                <span class="c1"># this function is from Mateen Ulhaq</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array</span> <span class="o">-</span> <span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">final_t</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_t_list</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">final_t</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;test_acc_list&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">test_asr</span> <span class="o">=</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;test_asr_list&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">test_ra</span> <span class="o">=</span> <span class="n">curve_record_dict</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;test_ra_list&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">agg</span> <span class="o">=</span> <span class="n">Metric_Aggregator</span><span class="p">()</span>
        <span class="n">agg</span><span class="p">({</span>
                <span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_asr</span><span class="p">,</span>
                <span class="s1">&#39;test_asr&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
                <span class="s1">&#39;test_ra&#39;</span><span class="p">:</span> <span class="n">test_ra</span><span class="p">,</span>
                <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">agg</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s2">/mcr_df_summary.csv&quot;</span><span class="p">)</span>

        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">new_netC_for_train_curve_aggregation</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_asr</span><span class="p">,</span>
                <span class="s1">&#39;test_asr&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
                <span class="s1">&#39;test_ra&#39;</span><span class="p">:</span> <span class="n">test_ra</span><span class="p">,</span>
                <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">defense_save_path</span><span class="si">}</span><span class="s1">/defense_result.pt&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_curve_one_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">netC</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">netC_optimizer</span><span class="p">,</span> <span class="n">netC_scheduler</span><span class="p">,</span> <span class="n">curve_netCs</span><span class="p">,</span>
                              <span class="n">curve_netCs_optimizers</span><span class="p">,</span> <span class="n">curve_netCs_schedulers</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">clean_train_dataloader</span><span class="p">,</span>
                              <span class="n">device</span><span class="p">):</span>

        <span class="n">netC</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">netC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">inter_netC</span> <span class="ow">in</span> <span class="n">curve_netCs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># skip the start and end model</span>
            <span class="n">inter_netC</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">inter_netC</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
            <span class="n">inter_netC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">curve_netCs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">curve_netCs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="n">curve_netCs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">curve_netCs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">curve_netCs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="n">curve_netCs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">batch_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clean_train_dataloader</span><span class="p">):</span>

            <span class="c1"># copy parameters and do weighted sum, from curve_netCs to netC</span>
            <span class="n">lookupDict_for_netCs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">inter_netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">())</span> <span class="k">for</span> <span class="n">inter_netC</span> <span class="ow">in</span> <span class="n">curve_netCs</span><span class="p">]</span>
            <span class="n">inter_netC_coefs</span> <span class="o">=</span> <span class="n">curve</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                    <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">inter_netC_idx</span><span class="p">,</span> <span class="n">lookupdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookupDict_for_netCs</span><span class="p">):</span>
                        <span class="n">weighted_parameter_from_curve_netCs</span> <span class="o">+=</span> <span class="n">lookupdict</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">inter_netC_coefs</span><span class="p">[</span>
                            <span class="n">inter_netC_idx</span><span class="p">]</span>
                    <span class="n">parameter</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                        <span class="n">weighted_parameter_from_curve_netCs</span>
                    <span class="p">)</span>

            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">netC</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="c1"># send back grad from netC to curve_netCs</span>
            <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">netC</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">inter_netC_idx</span><span class="p">,</span> <span class="n">lookupdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookupDict_for_netCs</span><span class="p">):</span>
                    <span class="n">lookupdict</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">grad</span> <span class="o">*</span> <span class="n">inter_netC_coefs</span><span class="p">[</span>
                        <span class="n">inter_netC_idx</span><span class="p">]</span>

            <span class="c1"># do step for all models</span>
            <span class="n">netC_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">inter_netC_optimizer</span> <span class="ow">in</span> <span class="n">curve_netCs_optimizers</span><span class="p">:</span>
                <span class="n">inter_netC_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_train_dataloader</span><span class="p">),</span> <span class="s1">&#39;Loss: </span><span class="si">%.3f</span><span class="s1"> | train Acc: </span><span class="si">%.3f%%</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">)&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">train_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="n">total</span><span class="p">))</span>

            <span class="n">batch_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="n">one_epoch_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">batch_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_loss</span><span class="p">)</span>

        <span class="c1"># update the all models&#39; scheduler</span>
        <span class="k">for</span> <span class="n">scheduler</span> <span class="ow">in</span> <span class="p">(</span><span class="n">curve_netCs_schedulers</span> <span class="o">+</span> <span class="p">[</span><span class="n">netC_scheduler</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">scheduler</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">==</span> <span class="s1">&#39;ReduceLROnPlateau&#39;</span><span class="p">:</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">one_epoch_loss</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">==</span> <span class="s1">&#39;CosineAnnealingLR&#39;</span><span class="p">:</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">netC</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">netC_optimizer</span><span class="p">,</span> <span class="n">netC_scheduler</span><span class="p">,</span> <span class="n">curve_netCs</span><span class="p">,</span> <span class="n">curve_netCs_optimizers</span><span class="p">,</span> <span class="n">curve_netCs_schedulers</span><span class="p">,</span> <span class="n">one_epoch_loss</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">mcr</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">mcr</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">mcr</span><span class="o">.</span><span class="n">add_yaml_to_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">mcr</span><span class="o">.</span><span class="n">process_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">mcr</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">mcr</span><span class="o">.</span><span class="n">defense</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, SCLBD.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>